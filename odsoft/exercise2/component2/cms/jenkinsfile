pipeline {
    agent any

    stages {
        
    	stage('Checkout'){
            steps {
           		checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'AuthorInChangelog']], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '0b06b803-ab5a-4de6-b9b2-26cef342e853', url: 'https://rafael95@bitbucket.org/mei-isep/odsoft-18-19-ifp-g114.git']]])
            }
    	}
    
    	stage('Preparation') {
    	    steps {
                script {
                    if (isUnix()) {
                        dir('odsoft/exercise2/component2/cms') {sh './gradlew cleanTest cleanIntegrationTest cleanJacocoTestReport cleanJacocoIntegrationReport'}
                    } else {
                        dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat cleanTest cleanIntegrationTest cleanJacocoTestReport cleanJacocoIntegrationReport'}
                    }
                }
    	    }
        }
    
    	stage('Build') {
            steps {
                script{
                    if (isUnix()) {
                    	dir('odsoft/exercise2/component2/cms') {sh './gradlew build'}
                    } else {
                    	dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat build'}
                    }
                }
            }
    	}
    
        stage("build and deploy on Windows and Linux") {
            parallel {
                
                stage('Archive war file'){
                    steps {
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'odsoft/exercise2/component2/cms/build/libs/*.war', fingerprint: true, onlyIfSuccessful: true
                    }
                }
    
                stage('Javadoc'){
                    steps {
                        script {
                            if (isUnix()) {
                                dir('odsoft/exercise2/component2/cms') {sh './gradlew javadoc'}
                            } else {
                                dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat javadoc'}
                            }
                        }
                
                        step([$class: 'JavadocArchiver', javadocDir: 'odsoft/exercise2/component2/cms/build/docs/javadoc', keepAll: false])
                    }
                }
    
                stage('Unit Tests'){
                    steps {
                        script {
                            if (isUnix()) {
                                dir('odsoft/exercise2/component2/cms') {sh './gradlew test'}
                            } else {
                                dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat test'}
                            }
                        }
                    }
                }
    
                stage('Integration Tests'){
                    steps {
                        script {
                            if (isUnix()) {
                                dir('odsoft/exercise2/component2/cms') {sh './gradlew integrationTest'}
                            } else {
                                dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat integrationTest'}
                            }
                        }
                    }

                }
            
                stage('System Tests'){
                    steps {
                        /*
                        script {
                            if (isUnix()) {
                                dir('odsoft/exercise2/component2/cms') {sh './gradlew systemTest'}
                            } else {
                                dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat systemTest'}
                            }
                        }
                        */
                        
                        echo "system tests under construction"
                    }
                }
            }
        }

        stage('Publish Tests Report'){
            steps {
                junit allowEmptyResults: true, testResults: 'odsoft/exercise2/component2/cms/build/test-results/test/*.xml'
            }
        }

        stage('Publish Coverage Report'){
            steps {
                jacoco classPattern: 'odsoft/exercise2/component2/cms/build/classes', exclusionPattern: '**/*Test*.class', execPattern: 'odsoft/exercise2/component2/cms/build/jacoco/*.exec', sourceExclusionPattern: '**/*Test*.java', sourcePattern: 'odsoft/exercise2/component2/cms/src/main/java'
            }
        }
    
        stage('Deploy'){
            steps {
                /*
                script {
                    if (isUnix()) {
                        dir('odsoft/exercise2/component2/cms') {sh './gradlew deploy'}
                    } else {
                        dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat deploy'}
                    }
                }
                */
                echo "Deploy under construction"
            }
        }
    
        stage('Smoke Tests'){
            steps {
                /*
                script {
                    if (isUnix()) {
                        dir('odsoft/exercise2/component2/cms') {sh './gradlew smokeTest'}
                    } else {
                        dir('odsoft/exercise2/component2/cms') {bat 'gradlew.bat smokeTest'}
                    }
                }
                */
                echo "Smoke tests under construction"
            }
        }

    }
}